# Obsidian Memory Manager - 架构设计文档

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                    obsidian-memory-manager                   │
│                      (统一调度层)                             │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  系统状态检测  │  │   意图识别    │  │  配置管理     │      │
│  │ check_system │  │ detect_intent │  │config_manager│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      技能调度层                               │
├──────────────┬──────────────┬───────────────────────────────┤
│obsidian-     │obsidian-     │obsidian-                      │
│bases-memory  │memory-       │memory-                        │
│(基础设施)    │recorder      │retriever                      │
│              │(记录)        │(检索)                         │
└──────────────┴──────────────┴───────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      数据存储层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │ memory/  │  │MEMORY.md │  │记忆数据库 │                   │
│  │  目录    │  │长期记忆  │  │ .base    │                   │
│  └──────────┘  └──────────┘  └──────────┘                   │
└─────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 系统状态检测 (check_system.py)

**职责**: 检测记忆系统的当前状态

**检测项**:
- `memory/` 目录是否存在
- `MEMORY.md` 文件是否存在
- `记忆数据库.base` 文件是否存在
- Obsidian 库路径是否有效

**返回状态**:
- `uninitialized`: 完全未初始化
- `partial`: 部分初始化
- `ready`: 完全就绪

### 2. 意图识别 (detect_intent.py)

**职责**: 分析用户输入，识别操作意图

**支持意图**:
- `initialize`: 初始化系统
- `record`: 记录信息
- `retrieve`: 检索信息
- `config`: 配置管理
- `status`: 状态检查
- `unknown`: 未知意图

**智能特性**:
- 关键词匹配
- 正则模式匹配
- 自动记录建议（当检测到决策陈述时）

### 3. 配置管理 (config_manager.py)

**职责**: 统一管理所有配置

**配置项**:
- `vault_path`: Obsidian 库路径
- `auto_initialize`: 是否自动初始化
- `auto_detect_intent`: 是否自动检测意图
- `components`: 三个子技能的配置
- `memory_rules`: 记忆规则配置
- `ui_preferences`: UI 偏好设置

## 工作流程

### 标准工作流程

```
用户输入
    │
    ▼
┌─────────────────┐
│   意图识别       │
│ detect_intent   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   系统状态检测   │
│  check_system   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   决策路由       │
│  (Manager Skill)│
└────────┬────────┘
         │
    ┌────┴────┐
    ▼         ▼
初始化    已就绪
    │         │
    ▼         ▼
调用      根据意图
bases-    调用相应
memory    子技能
```

### 初始化流程

```
触发初始化
    │
    ▼
检测系统状态
    │
    ├── 已就绪 ──→ 提示已初始化
    │
    └── 未初始化 ──→ 执行初始化
              │
              ▼
        1. 调用 bases-memory
           创建 infrastructure
              │
              ▼
        2. 生成默认配置
           manager_config.json
              │
              ▼
        3. 验证初始化结果
              │
              ▼
        4. 反馈初始化完成
```

### 记录流程

```
触发记录
    │
    ▼
分析内容
    │
    ├── 提取类型、标题、标签
    ├── 判断重要程度
    └── 识别项目关联
    │
    ▼
调用 recorder
    │
    ├── 获取标准时间
    ├── 写入 memory/{Date}.md
    └── 同步 MEMORY.md (如需要)
    │
    ▼
反馈记录结果
```

### 检索流程

```
触发检索
    │
    ▼
选择搜索模式
    │
    ├── 关键词搜索
    ├── 语义搜索
    └── 混合搜索 ← 默认
    │
    ▼
设置过滤条件（可选）
    │
    ├── 日期过滤
    ├── 类型过滤
    ├── 重要程度过滤
    └── 项目过滤
    │
    ▼
调用 retriever
    │
    ▼
格式化并展示结果
```

## 配置继承关系

```
manager_config.json (统一配置)
        │
        ├── vault_path ─────────┐
        │                       │
        ├── components.bases_memory
        │   ├── path
        │   └── init_script
        │                       │
        ├── components.recorder │
        │   ├── path            │
        │   ├── time_script     │
        │   └── auto_record_keywords
        │                       │
        └── components.retriever
            ├── path
            ├── default_search_mode
            └── search_scripts
                                │
                                ▼
                    各子技能读取配置
                    执行相应操作
```

## 扩展性设计

### 添加新的子技能

1. 在 `manager_config.json` 中添加配置
2. 在 `detect_intent.py` 中添加意图识别规则
3. 在 SKILL.md 中添加调度逻辑

### 自定义意图识别

修改 `detect_intent.py` 中的 `INTENT_PATTERNS`:

```python
INTENT_PATTERNS = {
    "new_intent": {
        "keywords": ["关键词1", "关键词2"],
        "patterns": [r"正则表达式"]
    }
}
```

### 自定义配置项

使用 `config_manager.py`:

```bash
python config_manager.py set custom.key value
```

## 错误处理

### 常见错误场景

| 错误场景 | 检测方式 | 处理策略 |
|---------|---------|---------|
| 系统未初始化 | check_system | 提示并引导初始化 |
| 配置缺失 | load_config | 使用默认配置 |
| 路径无效 | Path.exists | 提示检查路径 |
| 权限不足 | try-except | 提示检查权限 |

### 错误恢复

```python
try:
    result = operation()
except FileNotFoundError:
    # 尝试自动修复
    if auto_fix():
        result = operation()
    else:
        # 提示用户手动修复
        prompt_user_fix()
```

## 性能优化

### 缓存策略

- 配置缓存：避免重复读取配置文件
- 状态缓存：减少文件系统检查次数
- 结果缓存：缓存最近的搜索结果

### 延迟加载

- 按需加载子技能配置
- 延迟初始化组件
- 异步执行非关键操作

## 安全考虑

### 路径安全

- 验证所有路径在允许的范围内
- 防止路径遍历攻击
- 使用 Path 对象而非字符串拼接

### 配置安全

- 敏感配置项加密存储
- 配置文件权限控制
- 输入验证和清理
